name: CI
on: [ push ]

jobs:
  build:
    runs-on: ubuntu-20.04
    timeout-minutes: 15

    defaults:
      run:
        working-directory: docker

    steps:
      - uses: actions/checkout@v2

      - name: Setup Python + Poetry
        uses: moneymeets/action-setup-python-poetry@master

      - name: Run linter
        run: |
          find . -name '*.py' | xargs poetry run add-trailing-comma --py36-plus
          poetry run flake8

      - name: Run tests
        run: |
          poetry run coverage run -m pytest
          poetry run coverage report --fail-under 31

      - name: Export image name
        run: |
          # For branch names other than master (e.g. feature/test), append last branch name component (test) to the tag
          if [ "$GITHUB_REF" == "refs/heads/master" ]; then
            export TAG=latest
          else
            export TAG=${GITHUB_REF##*/}
          fi

          echo "IMAGE=moneymeets/ghd:$TAG" >> $GITHUB_ENV

      - name: Build image
        run: docker build --build-arg PYTHON_VERSION=${{ env.PYTHON_VERSION }} -t $IMAGE .

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Publish image
        run: docker push $IMAGE
